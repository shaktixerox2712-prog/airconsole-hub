<!DOCTYPE html>
<html>
<head>
<title>DesiConsole 3D Racing</title>
<style>
body { margin:0; overflow:hidden; background:black; }
#hud {
 position:absolute;
 top:10px;
 left:50%;
 transform:translateX(-50%);
 color:white;
 font-family:Arial;
 font-size:20px;
}
</style>
</head>
<body>

<div id="hud">Lap: 1 | Position: 1</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>

<script>
/* FIREBASE */
var firebaseConfig = {
  apiKey: "AIzaSyAOCz7nPegv2Rmf1FlpgZJQVUflwC-FFP8",
  authDomain: "airconsole-game-1c64b.firebaseapp.com",
  databaseURL: "https://airconsole-game-1c64b-default-rtdb.firebaseio.com",
  projectId: "airconsole-game-1c64b"
};

firebase.initializeApp(firebaseConfig);
var database = firebase.database();

var room = localStorage.getItem("room");
if(!room){ window.location.href="index.html"; }

/* THREE JS */
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

scene.background = new THREE.Color(0x000000);

let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(0,10,10);
scene.add(light);

/* ROAD */
let roadGeometry = new THREE.PlaneGeometry(20,1000);
let roadMaterial = new THREE.MeshStandardMaterial({color:0x222222});
let road = new THREE.Mesh(roadGeometry, roadMaterial);
road.rotation.x = -Math.PI/2;
scene.add(road);

/* CAR */
let carGeometry = new THREE.BoxGeometry(1,0.5,2);
let carMaterial = new THREE.MeshStandardMaterial({color:0xff0000});
let car = new THREE.Mesh(carGeometry, carMaterial);
car.position.y = 0.25;
scene.add(car);

camera.position.set(0,4,8);

/* SPEED SYSTEM */
let speed = 0;
let maxSpeed = 0.5;
let acceleration = 0.01;
let friction = 0.005;
let steeringPower = 0.05;

/* CONTROL STATE */
let control = {left:false, right:false, acc:false};

/* FIREBASE CONTROL LISTENER */
database.ref("rooms/"+room+"/control").on("value", function(snapshot){
 let data = snapshot.val();
 if(data){
   control = data;
 }
});

/* ANIMATE LOOP */
function animate(){
 requestAnimationFrame(animate);

 // Acceleration
 if(control.acc){
   speed += acceleration;
 } else {
   speed -= friction;
 }

 // Clamp speed
 if(speed < 0) speed = 0;
 if(speed > maxSpeed) speed = maxSpeed;

 // Steering (only if moving)
 if(speed > 0){
   if(control.left) car.position.x -= steeringPower * (speed*10);
   if(control.right) car.position.x += steeringPower * (speed*10);
 }

 // Boundary
 if(car.position.x < -8) car.position.x = -8;
 if(car.position.x > 8) car.position.x = 8;

 // Move forward
 car.position.z -= speed;

 // Camera follow
 camera.position.x = car.position.x;
 camera.position.z = car.position.z + 8;
 camera.lookAt(car.position);

 renderer.render(scene,camera);
}

animate();
</script>
