<!DOCTYPE html>
<html>
<head>
<title>DesiConsole 3D Racing</title>
<style>
body { margin:0; overflow:hidden; background:black; }
#hud {
 position:absolute;
 top:10px;
 left:50%;
 transform:translateX(-50%);
 color:white;
 font-family:Arial;
 font-size:20px;
}
</style>
</head>
<body>

<div id="hud">Lap: 1 | Position: 1</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>

/* FIREBASE */
var firebaseConfig = {
  apiKey: "AIzaSyAOCz7nPegv2Rmf1FlpgZJQVUflwC-FFP8",
  authDomain: "airconsole-game-1c64b.firebaseapp.com",
  databaseURL: "https://airconsole-game-1c64b-default-rtdb.firebaseio.com",
  projectId: "airconsole-game-1c64b"
};

firebase.initializeApp(firebaseConfig);
var database = firebase.database();
var room = localStorage.getItem("room");
if(!room){ window.location.href="index.html"; }

/* THREE SETUP */
let scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* LIGHT */
let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(0,10,10);
scene.add(light);

/* TRACK */
let trackGeometry = new THREE.RingGeometry(15,25,64);
let trackMaterial = new THREE.MeshStandardMaterial({color:0x333333, side:THREE.DoubleSide});
let track = new THREE.Mesh(trackGeometry, trackMaterial);
track.rotation.x = -Math.PI/2;
scene.add(track);

/* PLAYER CAR */
let carGeo = new THREE.BoxGeometry(1,0.5,2);
let carMat = new THREE.MeshStandardMaterial({color:0xff0000});
let car = new THREE.Mesh(carGeo, carMat);
car.position.y = 0.25;
scene.add(car);

let angle = 0;
let speed = 0;
let maxSpeed = 0.15;
let lap = 1;
let totalLaps = 3;

camera.position.set(0,5,10);

/* CONTROLLER STATE */
let moveLeft=false;
let moveRight=false;
let accelerate=false;

/* FIREBASE CONTROLLER LISTEN */
database.ref("rooms/"+room+"/control").on("value", function(snap){
 let data = snap.val();
 if(!data) return;

 moveLeft = data.left || false;
 moveRight = data.right || false;
 accelerate = data.acc || false;
});

/* GAME LOOP */
function animate(){
 requestAnimationFrame(animate);

 if(accelerate){
   speed += 0.002;
   if(speed > maxSpeed) speed = maxSpeed;
 } else {
   speed *= 0.98;
 }

 if(moveLeft) angle += 0.03;
 if(moveRight) angle -= 0.03;

 car.position.x = Math.cos(angle) * 20;
 car.position.z = Math.sin(angle) * 20;
 car.rotation.y = -angle + Math.PI/2;

 camera.position.x = car.position.x + Math.cos(angle)*8;
 camera.position.z = car.position.z + Math.sin(angle)*8;
 camera.lookAt(car.position);

 renderer.render(scene,camera);
}

animate();

</script>
</body>
</html>
