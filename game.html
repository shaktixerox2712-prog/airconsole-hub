<!DOCTYPE html>
<html>
<head>
<title>DesiConsole 3D Racing</title>
<style>
body { margin:0; overflow:hidden; background:black; }

#score {
 position:absolute;
 top:10px;
 left:50%;
 transform:translateX(-50%);
 color:white;
 font-family:Arial;
 font-size:22px;
}
</style>
</head>
<body>

<div id="score">Score: 0</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* FIREBASE */
var firebaseConfig = {
  apiKey: "AIzaSyAOCz7nPegv2Rmf1FlpgZJQVUflwC-FFP8",
  authDomain: "airconsole-game-1c64b.firebaseapp.com",
  databaseURL: "https://airconsole-game-1c64b-default-rtdb.firebaseio.com",
  projectId: "airconsole-game-1c64b"
};

firebase.initializeApp(firebaseConfig);
var database = firebase.database();

var room = localStorage.getItem("room");
if(!room){ window.location.href="index.html"; }

/* THREE SETUP */
let scene = new THREE.Scene();

let camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth/window.innerHeight,
  0.1,
  1000
);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

scene.background = new THREE.Color(0x000000);

/* LIGHT */
let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(0,10,10);
scene.add(light);

/* ROAD */
let roadGeometry = new THREE.PlaneGeometry(10,500);
let roadMaterial = new THREE.MeshStandardMaterial({color:0x333333});
let road = new THREE.Mesh(roadGeometry, roadMaterial);
road.rotation.x = -Math.PI/2;
scene.add(road);

/* PLAYER CAR */
let carGeometry = new THREE.BoxGeometry(1,0.5,2);
let carMaterial = new THREE.MeshStandardMaterial({color:0xff0000});
let car = new THREE.Mesh(carGeometry, carMaterial);
car.position.y = 0.25;
scene.add(car);

/* ENEMY CAR */
let enemyGeometry = new THREE.BoxGeometry(1,0.5,2);
let enemyMaterial = new THREE.MeshStandardMaterial({color:0xffff00});
let enemy = new THREE.Mesh(enemyGeometry, enemyMaterial);
enemy.position.y = 0.25;
enemy.position.z = -50;
enemy.position.x = (Math.random()*6)-3;
scene.add(enemy);

/* CAMERA POSITION */
camera.position.set(0,3,6);

/* GAME VARIABLES */
let speed = 0.6;
let score = 0;
let gameOver = false;
let scoreDisplay = document.getElementById("score");

let moveLeft = false;
let moveRight = false;

/* CONTROLLER LISTENER */
database.ref("rooms/"+room+"/move").on("value", function(snapshot){
 var direction = snapshot.val();

 moveLeft = false;
 moveRight = false;

 if(direction === "left") moveLeft = true;
 if(direction === "right") moveRight = true;
});

/* KEYBOARD BACKUP */
document.addEventListener("keydown", function(e){
 if(e.key === "ArrowLeft") moveLeft = true;
 if(e.key === "ArrowRight") moveRight = true;
});

document.addEventListener("keyup", function(){
 moveLeft = false;
 moveRight = false;
});

/* GAME LOOP */
function animate(){
 requestAnimationFrame(animate);

 if(gameOver) return;

 /* PLAYER MOVEMENT (SMOOTH) */
 if(moveLeft) car.position.x -= 0.15;
 if(moveRight) car.position.x += 0.15;

 /* BOUNDARY */
 if(car.position.x < -3) car.position.x = -3;
 if(car.position.x > 3) car.position.x = 3;

 /* ENEMY MOVE */
 enemy.position.z += speed;

 if(enemy.position.z > 5){
   enemy.position.z = -50;
   enemy.position.x = (Math.random()*6)-3;
   score += 10;
 }

 /* COLLISION */
 if(
   Math.abs(car.position.z - enemy.position.z) < 1.5 &&
   Math.abs(car.position.x - enemy.position.x) < 1
 ){
   gameOver = true;
   alert("Game Over! Score: " + score);
   location.reload();
 }

 /* SCORE UPDATE */
 scoreDisplay.innerText = "Score: " + score;

 /* CAMERA FOLLOW */
 camera.position.x = car.position.x;
 camera.position.z = car.position.z + 6;
 camera.lookAt(car.position);

 renderer.render(scene,camera);
}

animate();

/* RESPONSIVE */
window.addEventListener("resize", function(){
 camera.aspect = window.innerWidth/window.innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
