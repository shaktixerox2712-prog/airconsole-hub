<!DOCTYPE html>
<html>
<head>
<title>DesiConsole 3D Racing - Level 2</title>
<style>
body { margin:0; overflow:hidden; background:black; }
#score {
 position:absolute;
 top:10px;
 left:50%;
 transform:translateX(-50%);
 color:white;
 font-family:Arial;
 font-size:22px;
}
</style>
</head>
<body>

<div id="score">Score: 0</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>

/* FIREBASE */
var firebaseConfig = {
  apiKey: "AIzaSyAOCz7nPegv2Rmf1FlpgZJQVUflwC-FFP8",
  authDomain: "airconsole-game-1c64b.firebaseapp.com",
  databaseURL: "https://airconsole-game-1c64b-default-rtdb.firebaseio.com",
  projectId: "airconsole-game-1c64b"
};

firebase.initializeApp(firebaseConfig);
var database = firebase.database();

var room = localStorage.getItem("room");
if(!room){ window.location.href="index.html"; }

/* THREE SETUP */
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

scene.background = new THREE.Color(0x000000);

let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(0,10,10);
scene.add(light);

/* ROAD */
let road = new THREE.Mesh(
  new THREE.PlaneGeometry(10,500),
  new THREE.MeshStandardMaterial({color:0x222222})
);
road.rotation.x = -Math.PI/2;
scene.add(road);

/* LANE LINES */
for(let i=-200;i<200;i+=20){
 let line = new THREE.Mesh(
   new THREE.BoxGeometry(0.1,0.01,5),
   new THREE.MeshStandardMaterial({color:0xffffff})
 );
 line.position.set(0,0.01,i);
 scene.add(line);
}

/* CAR */
let car = new THREE.Mesh(
 new THREE.BoxGeometry(1,0.5,2),
 new THREE.MeshStandardMaterial({color:0xff0000})
);
car.position.y = 0.25;
scene.add(car);

/* ENEMY */
let enemy = new THREE.Mesh(
 new THREE.BoxGeometry(1,0.5,2),
 new THREE.MeshStandardMaterial({color:0xffff00})
);
enemy.position.y = 0.25;
enemy.position.z = -50;
scene.add(enemy);

/* LANES */
let lanes = [-2, 0, 2];
let currentLane = 1; // center
let targetX = lanes[currentLane];

/* SCORE */
let score = 0;
let scoreDisplay = document.getElementById("score");

/* CAMERA */
camera.position.set(0,4,6);

/* GAME LOOP */
function animate(){
 requestAnimationFrame(animate);

 // Smooth lane movement
 car.position.x += (targetX - car.position.x) * 0.1;

 // Move road
 road.position.z += 1;
 if(road.position.z > 250) road.position.z = 0;

 // Move enemy
 enemy.position.z += 1.5;

 if(enemy.position.z > 10){
   enemy.position.z = -50;
   enemy.position.x = lanes[Math.floor(Math.random()*3)];
   score += 10;
 }

 // Collision
 if(
   Math.abs(enemy.position.z - car.position.z) < 2 &&
   Math.abs(enemy.position.x - car.position.x) < 1
 ){
   alert("Game Over! Score: " + score);
   location.reload();
 }

 scoreDisplay.innerText = "Score: " + score;

 // Camera follow
 camera.position.x = car.position.x;
 camera.lookAt(car.position);

 renderer.render(scene,camera);
}

animate();

/* CONTROLLER */
database.ref("rooms/"+room+"/move").on("value", function(snapshot){
 let direction = snapshot.val();

 if(direction === "left"){
   if(currentLane > 0) currentLane--;
 }
 if(direction === "right"){
   if(currentLane < 2) currentLane++;
 }

 targetX = lanes[currentLane];
});

/* KEYBOARD BACKUP */
document.addEventListener("keydown", function(e){
 if(e.key === "ArrowLeft"){
   if(currentLane > 0) currentLane--;
 }
 if(e.key === "ArrowRight"){
   if(currentLane < 2) currentLane++;
 }

 targetX = lanes[currentLane];
});

</script>

</body>
</html>
